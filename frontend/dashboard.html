<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gestão à Vista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="text-center mb-4">Dashboard - Gestão à Vista</h2>

    <div class="d-flex flex-column flex-md-row justify-content-between mb-4 gap-3">
        <div>
            <a href="contas.html" class="btn btn-primary w-100">Cadastrar Conta</a>
        </div>
        <div>
            <a href="gastos.html" class="btn btn-success w-100">Cadastrar Gasto</a>
        </div>
        <div>
            <a href="index.html" class="btn btn-secondary w-100">Sair</a>
        </div>
    </div>

    <div class="mb-4">
        <h5>Selecione uma Conta:</h5>
        <select id="contaSelect" class="form-select" onchange="carregarGastos()">
            <option value="">Selecione...</option>
        </select>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h5>Gastos da Conta:</h5>
            <div id="gastos"></div>
        </div>

        <div class="col-md-6">
            <h5>Gráfico de Gastos:</h5>
            <canvas id="graficoGastos"></canvas>
        </div>
    </div>
</div>

<script>
const usuario_id = localStorage.getItem('usuario_id');
let chart = null;

function carregarContas() {
    fetch(`http://127.0.0.1:8000/contas/?usuario_id=${usuario_id}`)
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById('contaSelect');
        select.innerHTML = `<option value="">Selecione...</option>`;
        data.forEach(conta => {
            const option = document.createElement('option');
            option.value = conta.id;
            option.textContent = `${conta.nome} - R$${conta.valor_mensal}`;
            select.appendChild(option);
        });
    });
}

function carregarGastos() {
    const conta_id = document.getElementById('contaSelect').value;
    const container = document.getElementById('gastos');

    if (!conta_id) {
        container.innerHTML = "<p>Selecione uma conta para ver os gastos.</p>";
        limparGrafico();
        return;
    }

    fetch(`http://127.0.0.1:8000/gastos/?conta_id=${conta_id}`)
    .then(res => res.json())
    .then(data => {
        if (data.length === 0) {
            container.innerHTML = "<p>Sem gastos para essa conta.</p>";
            limparGrafico();
            return;
        }

        container.innerHTML = "";
        const labels = [];
        const valores = [];

        data.forEach(gasto => {
            container.innerHTML += `
                <div class="card mb-2 p-2">
                    <strong>${gasto.descricao || 'Sem descrição'}</strong><br>
                    Data: ${gasto.data}<br>
                    Valor: R$ ${gasto.valor.toFixed(2)}
                </div>
            `;
            labels.push(gasto.descricao || 'Sem descrição');
            valores.push(gasto.valor);
        });

        desenharGrafico(labels, valores);
    });
}

function desenharGrafico(labels, dados) {
    const ctx = document.getElementById('graficoGastos').getContext('2d');

    if (chart != null) {
        chart.destroy();
    }

    chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Gastos',
                data: dados,
                backgroundColor: gerarCores(labels.length),
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true
        }
    });
}

function gerarCores(qtd) {
    const cores = [];
    for (let i = 0; i < qtd; i++) {
        const cor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
        cores.push(cor);
    }
    return cores;
}

function limparGrafico() {
    if (chart != null) {
        chart.destroy();
        chart = null;
    }
}

carregarContas();
</script>

</body>
</html>
