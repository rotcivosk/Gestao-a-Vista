<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gestão à Vista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2>Dashboard</h2>
    <p>
        <a href="contas.html">Cadastrar Conta</a> | 
        <a href="gastos.html">Cadastrar Gasto</a> | 
        <a href="index.html">Sair</a>
    </p>

    <h4>Selecione uma Conta:</h4>
    <select id="contaSelect" class="form-select mb-3" onchange="carregarGastos()">
        <option value="">Selecione...</option>
    </select>

    <h4>Gastos da Conta:</h4>
    <div id="gastos"></div>

    <h4>Gráfico de Gastos:</h4>
    <canvas id="graficoGastos"></canvas>
</div>

<script>
const usuario_id = localStorage.getItem('usuario_id');
let chart = null; // variável para controlar o gráfico

// Carregar as contas no dropdown
function carregarContas() {
    fetch(`http://127.0.0.1:8000/contas/?usuario_id=${usuario_id}`)
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById('contaSelect');
        select.innerHTML = `<option value="">Selecione...</option>`;
        data.forEach(conta => {
            const option = document.createElement('option');
            option.value = conta.id;
            option.textContent = `${conta.nome} - R$${conta.valor_mensal}`;
            select.appendChild(option);
        });
    });
}

// Carregar os gastos da conta selecionada
function carregarGastos() {
    const conta_id = document.getElementById('contaSelect').value;
    const container = document.getElementById('gastos');

    if (!conta_id) {
        container.innerHTML = "<p>Selecione uma conta para ver os gastos.</p>";
        limparGrafico();
        return;
    }

    fetch(`http://127.0.0.1:8000/gastos/?conta_id=${conta_id}`)
    .then(res => res.json())
    .then(data => {
        if (data.length === 0) {
            container.innerHTML = "<p>Sem gastos para essa conta.</p>";
            limparGrafico();
            return;
        }

        container.innerHTML = "";
        const labels = [];
        const valores = [];

        data.forEach(gasto => {
            container.innerHTML += `
                <div class="card mb-2 p-2">
                    <strong>${gasto.descricao || 'Sem descrição'}</strong><br>
                    Data: ${gasto.data}<br>
                    Valor: R$ ${gasto.valor.toFixed(2)}
                </div>
            `;
            labels.push(gasto.descricao || 'Sem descrição');
            valores.push(gasto.valor);
        });

        desenharGrafico(labels, valores);
    });
}

// Desenhar gráfico
function desenharGrafico(labels, dados) {
    const ctx = document.getElementById('graficoGastos').getContext('2d');

    if (chart != null) {
        chart.destroy();
    }

    chart = new Chart(ctx, {
        type: 'pie', // pode ser 'bar' para barras
        data: {
            labels: labels,
            datasets: [{
                label: 'Gastos',
                data: dados,
                backgroundColor: gerarCores(labels.length),
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true
        }
    });
}

// Gerar cores aleatórias para os setores
function gerarCores(qtd) {
    const cores = [];
    for (let i = 0; i < qtd; i++) {
        const cor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
        cores.push(cor);
    }
    return cores;
}

// Limpar gráfico
function limparGrafico() {
    if (chart != null) {
        chart.destroy();
        chart = null;
    }
}

carregarContas();
</script>

</body>
</html>
