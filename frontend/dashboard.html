<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gest√£o √† Vista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">üìä Dashboard - Gest√£o √† Vista</h2>

    <div class="d-flex flex-column flex-md-row justify-content-between mb-4 gap-3">
        <a href="contas.html" class="btn btn-primary w-100">‚ûï Cadastrar Conta</a>
        <a href="gastos.html" class="btn btn-success w-100">üí∞ Cadastrar Gasto</a>
        <a href="index.html" class="btn btn-secondary w-100">‚èèÔ∏è Sair</a>
    </div>

    <div class="card p-4 mb-4">
        <h5>Selecione uma Conta:</h5>
        <select id="contaSelect" class="form-select mb-3" onchange="carregarGastos()">
            <option value="">Selecione...</option>
        </select>

        <div class="row">
            <div class="col-md-6">
                <h6>üîç Gastos da Conta:</h6>
                <div id="gastos"></div>
            </div>
            <div class="col-md-6">
                <h6>üìä Gr√°fico de Gastos (Pizza)</h6>
                <canvas id="graficoGastos"></canvas>
            </div>
        </div>
    </div>

    <div class="card p-4">
        <h5 class="text-center mb-4">üìà Gr√°fico de Linhas - Valor Mensal das Contas</h5>
        <canvas id="graficoContas"></canvas>
    </div>
</div>

<script>
const API_URL = window.location.origin;
const usuario_id = localStorage.getItem('usuario_id');

let chartPizza = null;
let chartLinhas = null;

// Carregar as contas no dropdown e gr√°fico de linhas
function carregarContas() {
    fetch(`${API_URL}/contas/?usuario_id=${usuario_id}`)
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById('contaSelect');
        select.innerHTML = `<option value="">Selecione...</option>`;
        data.forEach(conta => {
            const option = document.createElement('option');
            option.value = conta.id;
            option.textContent = `${conta.nome} - R$ ${conta.valor_mensal}`;
            select.appendChild(option);
        });

        desenharGraficoContas(data);
    });
}

// Carregar os gastos da conta selecionada
function carregarGastos() {
    const conta_id = document.getElementById('contaSelect').value;
    const container = document.getElementById('gastos');

    if (!conta_id) {
        container.innerHTML = "<p>Selecione uma conta para ver os gastos.</p>";
        limparGraficoPizza();
        return;
    }

    fetch(`${API_URL}/gastos/?conta_id=${conta_id}`)
    .then(res => res.json())
    .then(data => {
        if (data.length === 0) {
            container.innerHTML = "<p>Sem gastos para essa conta.</p>";
            limparGraficoPizza();
            return;
        }

        container.innerHTML = "";
        const labels = [];
        const valores = [];

        data.forEach(gasto => {
            container.innerHTML += `
                <div class="card mb-2 p-2">
                    <strong>${gasto.descricao || 'Sem descri√ß√£o'}</strong><br>
                    üìÖ Data: ${gasto.data}<br>
                    üí∞ Valor: R$ ${gasto.valor.toFixed(2)}
                </div>
            `;
            labels.push(gasto.descricao || 'Sem descri√ß√£o');
            valores.push(gasto.valor);
        });

        desenharGraficoPizza(labels, valores);
    });
}

// Desenhar gr√°fico de pizza dos gastos
function desenharGraficoPizza(labels, dados) {
    const ctx = document.getElementById('graficoGastos').getContext('2d');

    if (chartPizza != null) {
        chartPizza.destroy();
    }

    chartPizza = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Gastos',
                data: dados,
                backgroundColor: gerarCores(labels.length),
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true
        }
    });
}

// Desenhar gr√°fico de linhas dos valores das contas
function desenharGraficoContas(data) {
    const ctx = document.getElementById('graficoContas').getContext('2d');

    const labels = data.map(conta => conta.nome);
    const valores = data.map(conta => conta.valor_mensal);

    if (chartLinhas != null) {
        chartLinhas.destroy();
    }

    chartLinhas = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor Mensal das Contas',
                data: valores,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.2,
                pointBackgroundColor: 'rgb(75, 192, 192)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Contas'
                    }
                }
            }
        }
    });
}

// Gerar cores aleat√≥rias
function gerarCores(qtd) {
    const cores = [];
    for (let i = 0; i < qtd; i++) {
        const cor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
        cores.push(cor);
    }
    return cores;
}

// Limpar gr√°fico de pizza
function limparGraficoPizza() {
    if (chartPizza != null) {
        chartPizza.destroy();
        chartPizza = null;
    }
}

carregarContas();
</script>

</body>
</html>
