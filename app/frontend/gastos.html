<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Gastos - Gestão à Vista</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .is-invalid { border: 2px solid red; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="text-center mb-4">Cadastro de Gastos</h2>

  <div class="card p-4 mx-auto" style="max-width: 500px;">
    <div class="mb-3">
      <label class="form-label">Data:</label>
      <input type="date" id="data" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Valor:</label>
      <input type="text" id="valor" class="form-control" placeholder="R$ 0,00">
    </div>
    <div class="mb-3">
      <label class="form-label">Descrição:</label>
      <input id="descricao" class="form-control" placeholder="Ex.: Internet, Energia...">
    </div>
    <div class="mb-3">
      <label class="form-label">Conta:</label>
      <select id="contaSelect" class="form-select">
        <option value="">Selecione uma conta</option>
      </select>
    </div>
    <button class="btn btn-success w-100 mb-2" onclick="cadastrar()">Cadastrar</button>
    <a href="/frontend/dashboard.html" class="btn btn-secondary w-100">Voltar</a>

    <div id="resposta" class="mt-3 text-center"></div>
  </div>
</div>

<script>
const API_URL = window.location.origin;
const token = localStorage.getItem('access_token');

// ====== Formatar valor em tempo real ======
const valorInput = document.getElementById('valor');

valorInput.addEventListener('input', () => {
  let valor = valorInput.value.replace(/\D/g, '');
  valor = (parseInt(valor, 10) / 100).toFixed(2) + '';
  valor = valor.replace('.', ',');
  valorInput.value = `R$ ${valor}`;
});

// ====== Carregar contas ======
function carregarContas() {
  fetch(`${API_URL}/contas/`, {
    headers: { "Authorization": `Bearer ${token}` }
  })
  .then(res => {
    if (!res.ok) throw new Error("Erro ao carregar contas.");
    return res.json();
  })
  .then(data => {
    const select = document.getElementById('contaSelect');
    select.innerHTML = `<option value="">Selecione uma conta</option>`;
    data.forEach(conta => {
      const option = document.createElement('option');
      option.value = conta.id;
      option.textContent = `${conta.nome} - R$ ${conta.valor_mensal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      select.appendChild(option);
    });
  })
  .catch(() => {
    const select = document.getElementById('contaSelect');
    select.innerHTML = `<option value="">Erro ao carregar contas</option>`;
  });
}

// ====== Validação campo a campo ======
function validarCampos() {
  let valido = true;

  const data = document.getElementById('data');
  const valor = document.getElementById('valor');
  const descricao = document.getElementById('descricao');
  const conta = document.getElementById('contaSelect');

  if (!data.value) {
    data.classList.add('is-invalid');
    valido = false;
  } else {
    data.classList.remove('is-invalid');
  }

  if (!valor.value || valor.value === 'R$ 0,00') {
    valor.classList.add('is-invalid');
    valido = false;
  } else {
    valor.classList.remove('is-invalid');
  }

  if (!descricao.value.trim()) {
    descricao.classList.add('is-invalid');
    valido = false;
  } else {
    descricao.classList.remove('is-invalid');
  }

  if (!conta.value) {
    conta.classList.add('is-invalid');
    valido = false;
  } else {
    conta.classList.remove('is-invalid');
  }

  return valido;
}

// ====== Cadastrar gasto ======
function cadastrar() {
  if (!validarCampos()) {
    exibirErro("⚠️ Corrija os campos destacados.");
    return;
  }

  const data = document.getElementById('data').value;
  const valor = parseFloat(
    valorInput.value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()
  );
  const descricao = document.getElementById('descricao').value.trim();
  const conta_id = parseInt(document.getElementById('contaSelect').value);

  fetch(`${API_URL}/gastos/`, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({
      data: data,
      valor: valor,
      descricao: descricao,
      conta_id: conta_id
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Erro ao cadastrar gasto.");
    return res.json();
  })
  .then(() => {
    exibirSucesso("✅ Gasto cadastrado com sucesso!");
    setTimeout(() => window.location.href = "/frontend/dashboard.html", 1200);
  })
  .catch(() => {
    exibirErro("❌ Erro ao cadastrar gasto.");
  });
}

// ====== Helpers de mensagens ======
function exibirSucesso(msg) {
  const resposta = document.getElementById('resposta');
  resposta.innerText = msg;
  resposta.className = "alert alert-success";
}

function exibirErro(msg) {
  const resposta = document.getElementById('resposta');
  resposta.innerText = msg;
  resposta.className = "alert alert-danger";
}

carregarContas();
</script>

</body>
</html>
